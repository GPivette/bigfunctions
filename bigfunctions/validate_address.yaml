type: function_py
category: geo
author:
  name: Guillaume Pivette
  url: https://www.linkedin.com/in/guillaume-pivette
  avatar_url: ""
description: Validate `address` using Google Maps
arguments:
  - name: address
    type: string
output:
  name: validation_result
  type: string
examples:
  - description: "Precise address"
    arguments:
      - "'1 Avenue des Champs-Élysées, 75008 Paris, France'"
    output: |
      {'result': {'verdict': {'inputGranularity': 'PREMISE',
        'validationGranularity': 'PREMISE',
        'geocodeGranularity': 'PREMISE',
        'addressComplete': True},
        'address': {'formattedAddress': '1 Avenue des Champs-Élysées, 75008 Paris, France',
        ...},
        'geocode': {'location': {'latitude': 48.8698877, 'longitude': 2.3079341},
        ...,
        'bounds': {'low': {'latitude': 48.8698877, 'longitude': 2.3079341},
          'high': {'latitude': 48.8698877, 'longitude': 2.3079341}},
        ...}},
      'responseId': ...}
    region: ALL
  - description: "Address with inference"
    arguments:
      - "'1 Avenue des Champs-Élysées, 75008 Paris, France'"
    output: |
      {'result': {'verdict': {'inputGranularity': 'PREMISE',
        'validationGranularity': 'PREMISE',
        'geocodeGranularity': 'PREMISE',
        'addressComplete': True,
        'hasUnconfirmedComponents': True,
        'hasInferredComponents': True},
        'address': {
          'formattedAddress': '1 Avenue des Champs-Élysées, 75008 Paris, France',
          'addressComponents': [
            {'componentName': {'text': '1', 'languageCode': 'fr'},
              'componentType': 'street_number',
              'confirmationLevel': 'CONFIRMED'},
            {'componentName': {'text': 'rue des champs elysees', 'languageCode': 'fr'},
              'componentType': 'route',
              'confirmationLevel': 'UNCONFIRMED_BUT_PLAUSIBLE'},
            ...,]
          'unconfirmedComponentTypes': ['route']}
        'geocode': {'location': {'latitude': 48.8698877, 'longitude': 2.3079341},
        ...,
        'bounds': {'low': {'latitude': 48.8698877, 'longitude': 2.3079341},
          'high': {'latitude': 48.8698877, 'longitude': 2.3079341}},
        ...}},
      'responseId': ...}
    region: ALL
  - description: "Route granularity"
    arguments:
      - "'Avenue des Champs-Élysées, 75008 Paris, France'"
    output: |
      {'result': {'verdict': {inputGranularity': 'ROUTE',
        'validationGranularity': 'ROUTE',
        'geocodeGranularity': 'ROUTE'},
        'address': {
          'formattedAddress': 'Avenue des Champs-Élysées, 75008 Paris, France',
          'addressComponents': [
            {'componentName': {'text': 'Avenue des Champs-Élysées',
              'languageCode': 'fr'},
              'componentType': 'route',
              'confirmationLevel': 'CONFIRMED'},
            ...,]
          'missingComponentTypes': ['street_number']}
        'geocode': {'location': {'latitude': 48.8729602, 'longitude': 2.2978526},
        ...,
        'bounds': {'low': {'latitude': 48.8655318, 'longitude': 2.2952047},
          'high': {'latitude': 48.8748338, 'longitude': 2.3200376}},
        ...}},
      'responseId': ...}
    region: ALL
code: |
  import json
  import googlemaps
  import google.cloud.secretmanager
  secret_manager = google.cloud.secretmanager.SecretManagerServiceClient()
  gmaps_api_key = secret_manager.access_secret_version(
      name='projects/bigfunctions/secrets/gmaps_api_key/versions/latest'
  ).payload.data.decode('UTF-8')
  gmaps = googlemaps.Client(key=gmaps_api_key)
  address_validation = gmaps.addressvalidation(address)
  if not address_validation:
    return None
  return json.dumps(address_validation, ensure_ascii=False)
requirements: |
  google-cloud-secret-manager
  googlemaps
